{
  "implementation": "import pandas as pd\n\ndef calculate_ema(series, window):\n    return series.ewm(span=window, adjust=False).mean()\n\ndef calculate_macd(df):\n    close = df[\"Close\"]\n    ema12 = calculate_ema(close, 12)\n    ema26 = calculate_ema(close, 26)\n    macd = ema12 - ema26\n    macd_signal = calculate_ema(macd, 9)\n    return macd, macd_signal\n\ndef calculate_rsi(series, period):\n    delta = series.diff()\n    gain = (delta.where(delta > 0, 0)).rolling(window=period, min_periods=period).mean()\n    loss = (-delta.where(delta < 0, 0)).rolling(window=period, min_periods=period).mean()\n    rs = gain / loss\n    rsi = 100 - (100 / (1 + rs))\n    return rsi\n\ndef get_usd_holding(holdings):\n    for h in holdings:\n        if h[\"asset\"] == \"USD\":\n            return h\n    return None\n\ndef get_btc_holding(holdings):\n    for h in holdings:\n        if h[\"asset\"] == \"BTC\":\n            return h\n    return None\n\ndef get_last_btc_buy_price(holdings):\n    for h in holdings:\n        if h[\"asset\"] == \"BTC\":\n            return h.get(\"unit_value_usd\", None)\n    return None\n\ndef run(df, holdings):\n    if df is None or len(df) < 26:\n        return []\n\n    close = df[\"Close\"]\n    macd, macd_signal = calculate_macd(df)\n    rsi14 = calculate_rsi(close, 14)\n    sma21 = close.rolling(window=21, min_periods=21).mean()\n\n    last_close = float(close.iloc[-1])\n    last_macd = float(macd.iloc[-1])\n    last_macd_signal = float(macd_signal.iloc[-1])\n    last_rsi14 = float(rsi14.iloc[-1])\n    last_sma21 = float(sma21.iloc[-1])\n\n    usd_holding = get_usd_holding(holdings)\n    btc_holding = get_btc_holding(holdings)\n    last_btc_buy_price = get_last_btc_buy_price(holdings)\n\n    orders = []\n    # Buy condition\n    if btc_holding is None:\n        if (\n            last_macd > last_macd_signal\n            and last_rsi14 > 50\n            and last_close > last_sma21\n        ):\n            usd_available = usd_holding[\"amount\"] if usd_holding else 0\n            if usd_available > 0 and last_close > 0:\n                buy_amount = usd_available / last_close\n                take_profit = round(last_close * 1.20, 2)\n                stop_loss = round(last_close * 0.92, 2)\n                orders.append({\n                    \"action\": \"BUY\",\n                    \"asset\": \"BTC\",\n                    \"amount\": float(buy_amount),\n                    \"stop_loss\": stop_loss,\n                    \"take_profit\": take_profit,\n                })\n    else:\n        sell = False\n        if last_macd < last_macd_signal:\n            sell = True\n        if last_rsi14 < 50:\n            sell = True\n        if last_btc_buy_price is not None:\n            if last_close >= last_btc_buy_price * 1.20:\n                sell = True\n            if last_close <= last_btc_buy_price * 0.92:\n                sell = True\n        if sell:\n            orders.append({\n                \"action\": \"SELL\",\n                \"holding_id\": btc_holding[\"holding_id\"],\n                \"amount\": float(btc_holding[\"amount\"]),\n            })\n    return orders\n"
}